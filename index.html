<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culinary Business Hub</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Authentication Container -->
    <div id="auth-container" class="min-h-screen bg-gray-100 flex flex-col justify-center items-center p-4">
        <div class="max-w-sm w-full">
            <div class="text-center mb-8">
                <i class="fas fa-utensils text-5xl text-indigo-600"></i>
                <h1 class="text-3xl font-bold text-gray-800 mt-4">Culinary Business Hub</h1>
            </div>

            <!-- Login Form -->
            <div id="login-form-container" class="bg-white p-8 rounded-lg shadow-lg">
                <form id="login-form">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Login</h2>
                    <div id="login-error" class="hidden text-red-500 text-sm mb-4 text-center"></div>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Login</button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign up</a>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signup-form-container" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <form id="signup-form">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Create Account</h2>
                    <div id="signup-error" class="hidden text-red-500 text-sm mb-4 text-center"></div>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="signup-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="signup-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Sign Up</button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Login</a>
                </p>
            </div>
        </div>
    </div>


    <!-- Main App Container (hidden by default) -->
    <div id="app-container" class="hidden max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 flex justify-between items-center">
            <div class="text-center flex-grow">
                <h1 class="text-4xl font-bold text-indigo-600">Culinary Business Hub</h1>
                <p class="text-lg text-gray-600 mt-2">Your all-in-one tool for managing your food business with Catalina.</p>
            </div>
            <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex flex-wrap gap-x-4" aria-label="Tabs">
                <button onclick="showTab('dashboard')" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                 <button onclick="showTab('recipe-importer')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-magic mr-2"></i>Recipe Importer
                </button>
                <button onclick="showTab('providers')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-truck mr-2"></i>Providers
                </button>
                <button onclick="showTab('ingredients')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-carrot mr-2"></i>Ingredients
                </button>
                <button onclick="showTab('supplies')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-box mr-2"></i>Supplies
                </button>
                <button onclick="showTab('recipes')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-book-open mr-2"></i>Recipes
                </button>
                <button onclick="showTab('customers')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-users mr-2"></i>Customers
                </button>
                <button onclick="showTab('orders')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-receipt mr-2"></i>Orders
                </button>
                 <button onclick="showTab('howToUse')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-question-circle mr-2"></i>How to Use
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <h2 class="text-2xl font-semibold mb-4">Business Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500">Total Revenue</h3>
                        <p id="dashboard-revenue" class="text-3xl font-bold text-green-600">$0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500">Total Costs</h3>
                        <p id="dashboard-costs" class="text-3xl font-bold text-red-600">$0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500">Total Profit</h3>
                        <p id="dashboard-profit" class="text-3xl font-bold text-indigo-600">$0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500">Fulfilled Orders</h3>
                        <p id="dashboard-orders" class="text-3xl font-bold">0</p>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Recent Orders</h3>
                    <div id="dashboard-recent-orders" class="space-y-4">
                         <p class="text-gray-500">No recent orders to display.</p>
                    </div>
                </div>
            </div>
            
            <!-- Recipe Importer Tab -->
            <div id="recipe-importer-tab" class="tab-content">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4">AI Recipe Importer</h2>
                    <p class="text-gray-600 mb-6">Paste a URL from a recipe website, and the AI will attempt to extract the ingredients and create a new recipe for you.</p>
                    <div class="flex gap-2">
                        <input type="url" id="recipe-url-input" placeholder="https://www.allrecipes.com/..." class="flex-grow block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <button id="import-recipe-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700">
                            <span id="import-btn-text">Import</span>
                            <i id="import-spinner" class="fas fa-spinner fa-spin hidden"></i>
                        </button>
                    </div>
                    <div id="importer-error" class="text-red-500 text-sm mt-2 hidden"></div>
                    <div id="importer-result" class="mt-8"></div>
                </div>
            </div>

            <!-- Providers Tab -->
            <div id="providers-tab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Manage Providers</h2>
                    <button onclick="openModal('add-provider-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add Provider</button>
                </div>
                <div id="providers-list" class="bg-white p-4 rounded-lg shadow">
                    <!-- Providers list will be populated here -->
                </div>
            </div>

            <!-- Ingredients Tab -->
            <div id="ingredients-tab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Manage Ingredients</h2>
                    <button onclick="openModal('add-ingredient-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add Ingredient</button>
                </div>
                <div id="ingredients-list" class="bg-white p-4 rounded-lg shadow">
                    <!-- Ingredients list will be populated here -->
                </div>
            </div>

            <!-- Supplies Tab -->
            <div id="supplies-tab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Manage Supplies (Utensils, Packaging)</h2>
                    <button onclick="openModal('add-supply-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add Supply</button>
                </div>
                <div id="supplies-list" class="bg-white p-4 rounded-lg shadow">
                    <!-- Supplies list will be populated here -->
                </div>
            </div>

            <!-- Recipes Tab -->
            <div id="recipes-tab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Manage Recipes</h2>
                    <button onclick="openModal('add-recipe-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Create Recipe</button>
                </div>
                <div id="recipes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Recipes list will be populated here -->
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customers-tab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Manage Customers</h2>
                    <button onclick="openModal('add-customer-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-user-plus mr-2"></i>Add Customer</button>
                </div>
                <div id="customers-list" class="bg-white p-4 rounded-lg shadow">
                    <!-- Customers list will be populated here -->
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders-tab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Manage Orders</h2>
                    <button onclick="openModal('add-order-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>New Order</button>
                </div>
                <div id="orders-list" class="space-y-4">
                    <!-- Orders list will be populated here -->
                </div>
            </div>
            
            <!-- How to Use Tab -->
            <div id="howToUse-tab" class="tab-content">
                <div class="bg-white p-8 rounded-lg shadow-lg prose lg:prose-xl">
                    <h2 class="text-2xl font-semibold mb-4">How to Use the Culinary Business Hub</h2>
                    <p>Welcome, Dennis! Here’s a step-by-step guide to get you and Catalina started:</p>
                    <ol>
                        <li>
                            <strong><i class="fas fa-truck mr-2 text-indigo-500"></i>Add Providers:</strong> Go to the "Providers" tab to enter your suppliers like Costco, Sam's Club, etc.
                        </li>
                        <li>
                            <strong><i class="fas fa-carrot mr-2 text-indigo-500"></i>Add Ingredients:</strong> In the "Ingredients" tab, when you add an item, you can now select who you bought it from. This lets you add "Chicken Breast" from multiple providers to compare costs.
                        </li>
                        <li>
                            <strong><i class="fas fa-box mr-2 text-indigo-500"></i>Add Supplies:</strong> This is for non-food items like containers, forks, or napkins.
                        </li>
                        <li>
                            <strong><i class="fas fa-book-open mr-2 text-indigo-500"></i>Create Recipes:</strong> In the "Recipes" tab, build your menu items by selecting from the ingredients and supplies you've entered.
                        </li>
                         <li>
                            <strong><i class="fas fa-users mr-2 text-indigo-500"></i>Manage Customers:</strong> Keep track of your clients in the "Customers" tab.
                        </li>
                        <li>
                            <strong><i class="fas fa-receipt mr-2 text-indigo-500"></i>Log Orders:</strong> Head to the "Orders" tab to create, track, and fulfill customer orders.
                        </li>
                         <li>
                            <strong><i class="fas fa-chart-line mr-2 text-indigo-500"></i>Check the Dashboard:</strong> Get a real-time overview of your revenue, costs, and profits.
                        </li>
                    </ol>
                    <p class="mt-6 font-semibold text-indigo-600">This tool saves all your data in real-time, so you and Catalina can collaborate from anywhere. Good luck with the business!</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
     <!-- Add Provider Modal -->
    <div id="add-provider-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Add New Provider</h3>
            <form id="add-provider-form" class="space-y-4">
                <input type="hidden" id="provider-id">
                <div>
                    <label for="provider-name" class="block text-sm font-medium text-gray-700">Provider Name</label>
                    <input type="text" id="provider-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="provider-contact" class="block text-sm font-medium text-gray-700">Contact Info (Phone/Email/Rep)</label>
                    <input type="text" id="provider-contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="provider-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                    <textarea id="provider-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-provider-modal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Provider</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Ingredient Modal -->
    <div id="add-ingredient-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Add New Ingredient</h3>
            <form id="add-ingredient-form" class="space-y-4">
                <input type="hidden" id="ingredient-id">
                <div>
                    <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Ingredient Name</label>
                    <input type="text" id="ingredient-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                 <div>
                    <label for="ingredient-provider" class="block text-sm font-medium text-gray-700">Provider</label>
                    <select id="ingredient-provider" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <!-- Provider options populated here -->
                    </select>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Base Unit (for recipes)</label>
                        <input type="text" id="ingredient-unit" placeholder="e.g., gram, ml, piece" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                     <div>
                        <label for="ingredient-stock" class="block text-sm font-medium text-gray-700">Current Stock (in Base Unit)</label>
                        <input type="number" id="ingredient-stock" value="0" min="0" step="any" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="ingredient-purchase-size" class="block text-sm font-medium text-gray-700">Purchase Size</label>
                        <input type="number" id="ingredient-purchase-size" placeholder="e.g., 1000 (for 1kg)" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="ingredient-purchase-cost" class="block text-sm font-medium text-gray-700">Purchase Cost ($)</label>
                        <input type="number" id="ingredient-purchase-cost" placeholder="e.g., 10.50" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
                <div>
                    <label for="ingredient-yield" class="block text-sm font-medium text-gray-700">Yield (%)</label>
                    <input type="number" id="ingredient-yield" value="100" min="1" max="100" placeholder="e.g., 80 for chicken with bones" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <p class="text-xs text-gray-500 mt-1">Amount of usable product after prep. 100% if no waste.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-ingredient-modal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Ingredient</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Supply Modal -->
    <div id="add-supply-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Add New Supply</h3>
            <form id="add-supply-form" class="space-y-4">
                <input type="hidden" id="supply-id">
                <div>
                    <label for="supply-name" class="block text-sm font-medium text-gray-700">Supply Name</label>
                    <input type="text" id="supply-name" placeholder="e.g., Takeout Container, Fork" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                 <div>
                    <label for="supply-stock" class="block text-sm font-medium text-gray-700">Current Stock (pieces)</label>
                    <input type="number" id="supply-stock" value="0" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="supply-pack-size" class="block text-sm font-medium text-gray-700">Units per Pack</label>
                        <input type="number" id="supply-pack-size" placeholder="e.g., 100" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="supply-pack-cost" class="block text-sm font-medium text-gray-700">Cost per Pack ($)</label>
                        <input type="number" id="supply-pack-cost" placeholder="e.g., 15.00" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-supply-modal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Supply</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Recipe Modal -->
    <div id="add-recipe-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Create New Recipe</h3>
            <form id="add-recipe-form" class="space-y-4">
                <input type="hidden" id="recipe-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="recipe-name" class="block text-sm font-medium text-gray-700">Recipe Name</label>
                        <input type="text" id="recipe-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="recipe-price" class="block text-sm font-medium text-gray-700">Selling Price ($)</label>
                        <input type="number" id="recipe-price" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
                
                <!-- Recipe Items -->
                <div class="space-y-4">
                    <h4 class="text-lg font-medium text-gray-800">Recipe Items</h4>
                    <div id="recipe-items-container" class="space-y-2">
                        <!-- Items will be added here -->
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="addRecipeItem('ingredient')" class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300"><i class="fas fa-plus mr-1"></i>Add Ingredient</button>
                        <button type="button" onclick="addRecipeItem('supply')" class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300"><i class="fas fa-plus mr-1"></i>Add Supply</button>
                    </div>
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-recipe-modal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Recipe</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Add New Customer</h3>
            <form id="add-customer-form" class="space-y-4">
                <input type="hidden" id="customer-id">
                <div>
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">Customer Name</label>
                    <input type="text" id="customer-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="customer-contact" class="block text-sm font-medium text-gray-700">Contact Info (Phone/Email)</label>
                    <input type="text" id="customer-contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="customer-notes" class="block text-sm font-medium text-gray-700">Notes (Allergies, Preferences)</label>
                    <textarea id="customer-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-customer-modal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div id="add-order-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Create New Order</h3>
            <form id="add-order-form" class="space-y-4">
                <input type="hidden" id="order-id">
                <div>
                    <label for="order-customer" class="block text-sm font-medium text-gray-700">Customer</label>
                    <select id="order-customer" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <!-- Customer options populated here -->
                    </select>
                </div>

                <!-- Order Items -->
                <div class="space-y-4">
                    <h4 class="text-lg font-medium text-gray-800">Order Items</h4>
                    <div id="order-items-container" class="space-y-2">
                        <!-- Order items will be added here -->
                    </div>
                    <button type="button" onclick="addOrderItem()" class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300"><i class="fas fa-plus mr-1"></i>Add Recipe to Order</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label for="order-discount" class="block text-sm font-medium text-gray-700">Discount (%)</label>
                        <input type="number" id="order-discount" value="0" min="0" max="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="order-status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="order-status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option>Pending</option>
                            <option>In Progress</option>
                            <option>Fulfilled</option>
                            <option>Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-order-modal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Order</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal-backdrop">
        <div class="modal-content max-w-sm">
            <h3 class="text-xl font-semibold mb-2">Are you sure?</h3>
            <p id="delete-confirm-message" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button type="button" onclick="closeModal('delete-confirm-modal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCFoDduJ9pRL2lAGvYek3AyhVb066SdpGw",
            authDomain: "catalina-culinary-hub.firebaseapp.com",
            projectId: "catalina-culinary-hub",
            storageBucket: "catalina-culinary-hub.firebasestorage.app",
            messagingSenderId: "32561043797",
            appId: "1:32561043797:web:a9c4454e346845d78677dc"
        };
        // --- END OF FIREBASE CONFIGURATION ---

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let providersCache = [];
        let ingredientsCache = [];
        let suppliesCache = [];
        let recipesCache = [];
        let customersCache = [];
        let ordersCache = [];
        const businessId = "shared-business-data"; // This is the shared folder for you and Catalina
        
        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginFormContainer = document.getElementById('login-form-container');
        const signupFormContainer = document.getElementById('signup-form-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');

        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                userId = user.uid; // We still need this for security rules
                initializeAppState();
            } else {
                // User is signed out
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                userId = null;
                // Detach listeners when logged out
                listeners.forEach(unsubscribe => unsubscribe());
                listeners = [];
            }
        });

        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login Error:", error.message);
                loginError.textContent = "Failed to login. Please check your email and password.";
                loginError.classList.remove('hidden');
            }
        });

        // Signup form submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            signupError.classList.add('hidden');

            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Signup Error:", error.message);
                signupError.textContent = "Failed to create account. The email might already be in use.";
                signupError.classList.remove('hidden');
            }
        });
        
        // Logout button
        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        // Toggle between Login and Signup forms
        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer.classList.add('hidden');
            signupFormContainer.classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            signupFormContainer.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
        });

        // Initial check for firebase config
        if (firebaseConfig.apiKey === "PASTE_YOUR_API_KEY_HERE") {
            document.body.innerHTML = `<div class="text-center p-8 text-red-500 font-bold">Error: Firebase configuration is missing. Please follow the setup instructions to add your configuration to the index.html file.</div>`;
        }


        function getCollectionRef(collectionName) {
            // IMPORTANT: This now points to a SHARED business data path
            if (!userId) return null;
            return collection(db, 'businesses', businessId, collectionName);
        }

        // --- App Initialization ---
        function initializeAppState() {
            if (!userId) return;
            console.log("Initializing app state for user:", userId);
            setupListeners();
            setupFormSubmissions();
        }

        // --- Real-time Data Listeners ---
        let listeners = [];
        function setupListeners() {
            // Detach old listeners if they exist to prevent memory leaks on re-login
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];

            const collections = ['providers', 'ingredients', 'supplies', 'recipes', 'customers', 'orders'];
            collections.forEach(name => {
                const collRef = getCollectionRef(name);
                if (!collRef) return; // Don't attach listener if user isn't logged in

                const unsubscribe = onSnapshot(collRef, (snapshot) => {
                    const cacheName = `${name}Cache`;
                    window[cacheName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Call the specific render function
                    const renderFuncName = `render${name.charAt(0).toUpperCase() + name.slice(1)}`;
                    if(window[renderFuncName]) window[renderFuncName]();

                    // Special cases
                    if(name === 'providers') populateProviderDropdowns();
                    if(name === 'customers') populateCustomerDropdowns();
                    if(name === 'orders') updateDashboard();

                }, (error) => console.error(`${name} listener error: `, error));
                listeners.push(unsubscribe);
            });
        }
        
        // --- UI Rendering Functions ---
        
        window.renderProviders = function() {
            const list = document.getElementById('providers-list');
             if (providersCache.length === 0) {
                list.innerHTML = `<p class="text-gray-500">No providers added yet. Click "Add Provider" to start.</p>`;
                return;
            }
            list.innerHTML = providersCache.map(prov => `
                <div class="p-4 border-b grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <div class="font-semibold">${prov.name}</div>
                    <div class="text-sm text-gray-600">${prov.contact || 'No contact info'}</div>
                    <div class="flex justify-end gap-2">
                        <button onclick="editProvider('${prov.id}')" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="confirmDelete('provider', '${prov.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        window.renderIngredients = function() {
            const list = document.getElementById('ingredients-list');
            if (ingredientsCache.length === 0) {
                list.innerHTML = `<p class="text-gray-500">No ingredients added yet. Click "Add Ingredient" to start.</p>`;
                return;
            }
            list.innerHTML = ingredientsCache.map(ing => {
                const provider = providersCache.find(p => p.id === ing.providerId);
                const costPerUnit = (ing.purchaseCost / ing.purchaseSize) / (ing.yield / 100);
                return `
                <div class="p-4 border-b grid grid-cols-2 md:grid-cols-6 gap-4 items-center">
                    <div class="font-semibold col-span-2 md:col-span-1">${ing.name}</div>
                    <div class="text-sm text-gray-600">${provider?.name || 'N/A'}</div>
                    <div class="text-sm text-gray-600">Stock: ${ing.stock} ${ing.unit}</div>
                    <div class="text-sm text-gray-600">Cost/Unit: $${costPerUnit.toFixed(4)}</div>
                    <div class="text-sm text-gray-600">Yield: ${ing.yield}%</div>
                    <div class="flex justify-end gap-2">
                        <button onclick="editIngredient('${ing.id}')" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="confirmDelete('ingredient', '${ing.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        window.renderSupplies = function() {
            const list = document.getElementById('supplies-list');
            if (suppliesCache.length === 0) {
                list.innerHTML = `<p class="text-gray-500">No supplies added yet. Click "Add Supply" to start.</p>`;
                return;
            }
            list.innerHTML = suppliesCache.map(sup => {
                const costPerUnit = sup.packCost / sup.packSize;
                return `
                <div class="p-4 border-b grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                    <div class="font-semibold col-span-2 md:col-span-1">${sup.name}</div>
                    <div class="text-sm text-gray-600">Stock: ${sup.stock} units</div>
                    <div class="text-sm text-gray-600">Cost/Unit: $${costPerUnit.toFixed(4)}</div>
                    <div class="flex justify-end gap-2">
                        <button onclick="editSupply('${sup.id}')" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="confirmDelete('supply', '${sup.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        window.renderRecipes = function() {
            const list = document.getElementById('recipes-list');
            if (recipesCache.length === 0) {
                list.innerHTML = `<p class="text-gray-500 col-span-full">No recipes created yet. Click "Create Recipe" to start.</p>`;
                return;
            }
            list.innerHTML = recipesCache.map(rec => {
                const cost = calculateRecipeCost(rec);
                const profit = rec.price - cost;
                return `
                <div class="bg-white p-6 rounded-lg shadow space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold">${rec.name}</h3>
                            <p class="text-indigo-600 font-semibold">Sell Price: $${rec.price.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="editRecipe('${rec.id}')" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="confirmDelete('recipe', '${rec.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm">Cost: <span class="font-medium">$${cost.toFixed(2)}</span></p>
                        <p class="text-sm">Profit: <span class="font-medium ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">$${profit.toFixed(2)}</span></p>
                    </div>
                    <div class="pt-4 border-t">
                        <label class="text-sm font-medium">Profit Calculator</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="number" value="1" min="1" class="w-20 rounded-md border-gray-300 shadow-sm text-sm" oninput="updateMultiportionProfit(this, ${cost}, ${rec.price})">
                            <span id="multi-profit-${rec.id}" class="text-sm font-semibold">Profit: $${profit.toFixed(2)}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        window.renderCustomers = function() {
            const list = document.getElementById('customers-list');
             if (customersCache.length === 0) {
                list.innerHTML = `<p class="text-gray-500">No customers added yet. Click "Add Customer" to start.</p>`;
                return;
            }
            list.innerHTML = customersCache.map(cust => `
                <div class="p-4 border-b grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <div class="font-semibold">${cust.name}</div>
                    <div class="text-sm text-gray-600">${cust.contact || 'No contact info'}</div>
                    <div class="flex justify-end gap-2">
                        <button onclick="editCustomer('${cust.id}')" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="confirmDelete('customer', '${cust.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        window.renderOrders = function() {
            const list = document.getElementById('orders-list');
            if (ordersCache.length === 0) {
                list.innerHTML = `<p class="text-gray-500">No orders placed yet. Click "New Order" to start.</p>`;
                return;
            }
            const sortedOrders = ordersCache.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            list.innerHTML = sortedOrders.map(order => {
                const customer = customersCache.find(c => c.id === order.customerId);
                const { totalCost, totalPrice } = calculateOrderTotals(order);
                const statusColor = {
                    'Pending': 'bg-yellow-100 text-yellow-800',
                    'In Progress': 'bg-blue-100 text-blue-800',
                    'Fulfilled': 'bg-green-100 text-green-800',
                    'Cancelled': 'bg-red-100 text-red-800',
                }[order.status];

                return `
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <div>
                            <h3 class="text-lg font-bold">Order #${order.id.substring(0, 6)}...</h3>
                            <p class="text-sm text-gray-600">Customer: ${customer?.name || 'N/A'}</p>
                            <p class="text-sm text-gray-600">Date: ${order.createdAt?.toDate().toLocaleDateString() || 'N/A'}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="px-3 py-1 text-sm font-medium rounded-full ${statusColor}">${order.status}</span>
                             <div class="flex gap-2">
                                <button onclick="editOrder('${order.id}')" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-pencil-alt"></i></button>
                                <button onclick="confirmDelete('order', '${order.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="text-sm space-y-1 mb-4">
                        ${order.items.map(item => {
                            const recipe = recipesCache.find(r => r.id === item.recipeId);
                            return `<p>${item.quantity} x ${recipe?.name || 'Deleted Recipe'}</p>`;
                        }).join('')}
                    </div>
                    <div class="pt-4 border-t flex flex-wrap justify-between items-center gap-2 text-sm">
                        <p>Discount: <span class="font-medium">${order.discount}%</span></p>
                        <p>Total Price: <span class="font-medium">$${totalPrice.toFixed(2)}</span></p>
                        <p>Total Cost: <span class="font-medium">$${totalCost.toFixed(2)}</span></p>
                        <p>Profit: <span class="font-medium ${totalPrice - totalCost >= 0 ? 'text-green-600' : 'text-red-600'}">$${(totalPrice - totalCost).toFixed(2)}</span></p>
                    </div>
                </div>
                `;
            }).join('');
        }

        window.updateDashboard = function() {
            const fulfilledOrders = ordersCache.filter(o => o.status === 'Fulfilled');
            let totalRevenue = 0;
            let totalCosts = 0;

            fulfilledOrders.forEach(order => {
                const { totalPrice, totalCost } = calculateOrderTotals(order);
                totalRevenue += totalPrice;
                totalCosts += totalCost;
            });

            document.getElementById('dashboard-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('dashboard-costs').textContent = `$${totalCosts.toFixed(2)}`;
            document.getElementById('dashboard-profit').textContent = `$${(totalRevenue - totalCosts).toFixed(2)}`;
            document.getElementById('dashboard-orders').textContent = fulfilledOrders.length;
            
            // Recent Orders
            const recentOrdersContainer = document.getElementById('dashboard-recent-orders');
            const recentOrders = ordersCache.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)).slice(0, 5);
            if(recentOrders.length > 0) {
                recentOrdersContainer.innerHTML = recentOrders.map(order => {
                    const customer = customersCache.find(c => c.id === order.customerId);
                    const { totalPrice } = calculateOrderTotals(order);
                     return `
                        <div class="flex justify-between items-center p-2 rounded-md hover:bg-gray-50">
                            <div>
                                <p class="font-medium">${customer?.name || 'N/A'}</p>
                                <p class="text-xs text-gray-500">Order #${order.id.substring(0,6)}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">$${totalPrice.toFixed(2)}</p>
                                <p class="text-xs text-gray-500">${order.status}</p>
                            </div>
                        </div>`;
                }).join('');
            } else {
                 recentOrdersContainer.innerHTML = `<p class="text-gray-500">No recent orders to display.</p>`;
            }
        }

        // --- Form Submissions ---
        function setupFormSubmissions() {
            // Provider Form
            document.getElementById('add-provider-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const collRef = getCollectionRef('providers');
                if(!collRef) return;
                const id = document.getElementById('provider-id').value;
                const data = {
                    name: document.getElementById('provider-name').value,
                    contact: document.getElementById('provider-contact').value,
                    notes: document.getElementById('provider-notes').value,
                };
                if (id) {
                    await setDoc(doc(collRef, id), data);
                } else {
                    await addDoc(collRef, data);
                }
                closeModal('add-provider-modal');
            });

            // Ingredient Form
            document.getElementById('add-ingredient-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const collRef = getCollectionRef('ingredients');
                if(!collRef) return;
                const id = document.getElementById('ingredient-id').value;
                const data = {
                    name: document.getElementById('ingredient-name').value,
                    providerId: document.getElementById('ingredient-provider').value,
                    unit: document.getElementById('ingredient-unit').value,
                    stock: parseFloat(document.getElementById('ingredient-stock').value),
                    purchaseSize: parseFloat(document.getElementById('ingredient-purchase-size').value),
                    purchaseCost: parseFloat(document.getElementById('ingredient-purchase-cost').value),
                    yield: parseFloat(document.getElementById('ingredient-yield').value),
                };
                if (id) {
                    await setDoc(doc(collRef, id), data);
                } else {
                    await addDoc(collRef, data);
                }
                closeModal('add-ingredient-modal');
            });

            // Supply Form
            document.getElementById('add-supply-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const collRef = getCollectionRef('supplies');
                if(!collRef) return;
                const id = document.getElementById('supply-id').value;
                const data = {
                    name: document.getElementById('supply-name').value,
                    stock: parseInt(document.getElementById('supply-stock').value, 10),
                    packSize: parseInt(document.getElementById('supply-pack-size').value, 10),
                    packCost: parseFloat(document.getElementById('supply-pack-cost').value)
                };
                if (id) {
                    await setDoc(doc(collRef, id), data);
                } else {
                    await addDoc(collRef, data);
                }
                closeModal('add-supply-modal');
            });
            
            // Customer Form
            document.getElementById('add-customer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const collRef = getCollectionRef('customers');
                if(!collRef) return;
                const id = document.getElementById('customer-id').value;
                const data = {
                    name: document.getElementById('customer-name').value,
                    contact: document.getElementById('customer-contact').value,
                    notes: document.getElementById('customer-notes').value,
                };
                if (id) {
                    await setDoc(doc(collRef, id), data);
                } else {
                    await addDoc(collRef, data);
                }
                closeModal('add-customer-modal');
            });

            // Recipe Form
            document.getElementById('add-recipe-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const collRef = getCollectionRef('recipes');
                if(!collRef) return;
                const id = document.getElementById('recipe-id').value;
                const items = [];
                document.querySelectorAll('.recipe-item-row').forEach(row => {
                    items.push({
                        type: row.dataset.type,
                        id: row.querySelector('select').value,
                        quantity: parseFloat(row.querySelector('input[type="number"]').value)
                    });
                });
                const data = {
                    name: document.getElementById('recipe-name').value,
                    price: parseFloat(document.getElementById('recipe-price').value),
                    items: items.filter(item => item.id && item.quantity > 0)
                };

                if (id) {
                    await setDoc(doc(collRef, id), data);
                } else {
                    await addDoc(collRef, data);
                }
                closeModal('add-recipe-modal');
            });

            // Order Form
            document.getElementById('add-order-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const collRef = getCollectionRef('orders');
                if(!collRef) return;
                const id = document.getElementById('order-id').value;
                const items = [];
                document.querySelectorAll('.order-item-row').forEach(row => {
                    items.push({
                        recipeId: row.querySelector('select').value,
                        quantity: parseInt(row.querySelector('input[type="number"]').value, 10)
                    });
                });
                const data = {
                    customerId: document.getElementById('order-customer').value,
                    status: document.getElementById('order-status').value,
                    discount: parseFloat(document.getElementById('order-discount').value) || 0,
                    items: items.filter(item => item.recipeId && item.quantity > 0),
                    createdAt: new Date()
                };
                
                const oldOrder = id ? ordersCache.find(o => o.id === id) : null;
                
                if (id) {
                    delete data.createdAt; // Don't overwrite creation date on edit
                    await setDoc(doc(collRef, id), data, { merge: true });
                } else {
                    await addDoc(collRef, data);
                }

                await updateStockLevels(data, oldOrder);

                closeModal('add-order-modal');
            });
        }
        
        // --- Edit and Delete Functions ---
        
        window.editProvider = (id) => {
            const prov = providersCache.find(p => p.id === id);
            if (!prov) return;
            document.getElementById('provider-id').value = id;
            document.getElementById('provider-name').value = prov.name;
            document.getElementById('provider-contact').value = prov.contact;
            document.getElementById('provider-notes').value = prov.notes;
            openModal('add-provider-modal');
        };

        window.editIngredient = (id) => {
            const ing = ingredientsCache.find(i => i.id === id);
            if (!ing) return;
            document.getElementById('ingredient-id').value = id;
            document.getElementById('ingredient-name').value = ing.name;
            document.getElementById('ingredient-provider').value = ing.providerId;
            document.getElementById('ingredient-unit').value = ing.unit;
            document.getElementById('ingredient-stock').value = ing.stock;
            document.getElementById('ingredient-purchase-size').value = ing.purchaseSize;
            document.getElementById('ingredient-purchase-cost').value = ing.purchaseCost;
            document.getElementById('ingredient-yield').value = ing.yield;
            openModal('add-ingredient-modal');
        };
        
        window.editSupply = (id) => {
            const sup = suppliesCache.find(s => s.id === id);
            if (!sup) return;
            document.getElementById('supply-id').value = id;
            document.getElementById('supply-name').value = sup.name;
            document.getElementById('supply-stock').value = sup.stock;
            document.getElementById('supply-pack-size').value = sup.packSize;
            document.getElementById('supply-pack-cost').value = sup.packCost;
            openModal('add-supply-modal');
        };

        window.editCustomer = (id) => {
            const cust = customersCache.find(c => c.id === id);
            if (!cust) return;
            document.getElementById('customer-id').value = id;
            document.getElementById('customer-name').value = cust.name;
            document.getElementById('customer-contact').value = cust.contact;
            document.getElementById('customer-notes').value = cust.notes;
            openModal('add-customer-modal');
        };

        window.editRecipe = (id) => {
            const rec = recipesCache.find(r => r.id === id);
            if (!rec) return;
            document.getElementById('recipe-id').value = id;
            document.getElementById('recipe-name').value = rec.name;
            document.getElementById('recipe-price').value = rec.price;
            
            const container = document.getElementById('recipe-items-container');
            container.innerHTML = '';
            rec.items.forEach(item => {
                addRecipeItem(item.type, item.id, item.quantity);
            });
            openModal('add-recipe-modal');
        };

        window.editOrder = (id) => {
            const order = ordersCache.find(o => o.id === id);
            if (!order) return;
            document.getElementById('order-id').value = id;
            document.getElementById('order-customer').value = order.customerId;
            document.getElementById('order-status').value = order.status;
            document.getElementById('order-discount').value = order.discount;

            const container = document.getElementById('order-items-container');
            container.innerHTML = '';
            order.items.forEach(item => {
                addOrderItem(item.recipeId, item.quantity);
            });
            openModal('add-order-modal');
        };
        
        window.confirmDelete = (type, id) => {
            const modal = document.getElementById('delete-confirm-modal');
            const message = document.getElementById('delete-confirm-message');
            const button = document.getElementById('confirm-delete-button');
            
            message.textContent = `Are you sure you want to delete this ${type}? This action cannot be undone.`;
            button.onclick = () => performDelete(type, id);
            
            openModal('delete-confirm-modal');
        };
        
        async function performDelete(type, id) {
            try {
                const collRef = getCollectionRef(type + 's');
                if(!collRef) return;
                // If an order is deleted, we need to reverse stock changes if it was fulfilled
                if (type === 'order') {
                    const order = ordersCache.find(o => o.id === id);
                    if (order && order.status === 'Fulfilled') {
                        // Re-add stock
                        await updateStockLevels(null, order);
                    }
                }
                await deleteDoc(doc(collRef, id));
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                alert(`Could not delete ${type}. It might be in use in a recipe or order.`);
            }
            closeModal('delete-confirm-modal');
        }

        // --- Helper & Calculation Functions ---
        
        function calculateRecipeCost(recipe) {
            if (!recipe.items) return 0;
            return recipe.items.reduce((total, item) => {
                let itemCost = 0;
                if (item.type === 'ingredient') {
                    const ing = ingredientsCache.find(i => i.id === item.id);
                    if (ing) {
                        const costPerUnit = (ing.purchaseCost / ing.purchaseSize) / (ing.yield / 100);
                        itemCost = costPerUnit * item.quantity;
                    }
                } else if (item.type === 'supply') {
                    const sup = suppliesCache.find(s => s.id === item.id);
                    if (sup) {
                        const costPerUnit = sup.packCost / sup.packSize;
                        itemCost = costPerUnit * item.quantity;
                    }
                }
                return total + itemCost;
            }, 0);
        }

        function calculateOrderTotals(order) {
            let totalCost = 0;
            let subtotalPrice = 0;
            order.items.forEach(item => {
                const recipe = recipesCache.find(r => r.id === item.recipeId);
                if (recipe) {
                    totalCost += calculateRecipeCost(recipe) * item.quantity;
                    subtotalPrice += recipe.price * item.quantity;
                }
            });
            const discountAmount = subtotalPrice * (order.discount / 100);
            const totalPrice = subtotalPrice - discountAmount;
            return { totalCost, totalPrice };
        }

        async function updateStockLevels(newOrder, oldOrder) {
            const batch = writeBatch(db);
            const stockChanges = {}; // { type: { id: change } }

            // Calculate changes from old order (if it exists and was fulfilled)
            if (oldOrder && oldOrder.status === 'Fulfilled') {
                oldOrder.items.forEach(item => {
                    const recipe = recipesCache.find(r => r.id === item.recipeId);
                    if (recipe) {
                        recipe.items.forEach(recipeItem => {
                            const change = item.quantity * recipeItem.quantity;
                            if (!stockChanges[recipeItem.type]) stockChanges[recipeItem.type] = {};
                            stockChanges[recipeItem.type][recipeItem.id] = (stockChanges[recipeItem.type][recipeItem.id] || 0) + change; // Add back
                        });
                    }
                });
            }

            // Calculate changes from new order (if it exists and is fulfilled)
            if (newOrder && newOrder.status === 'Fulfilled') {
                 newOrder.items.forEach(item => {
                    const recipe = recipesCache.find(r => r.id === item.recipeId);
                    if (recipe) {
                        recipe.items.forEach(recipeItem => {
                            const change = item.quantity * recipeItem.quantity;
                            if (!stockChanges[recipeItem.type]) stockChanges[recipeItem.type] = {};
                            stockChanges[recipeItem.type][recipeItem.id] = (stockChanges[recipeItem.type][recipeItem.id] || 0) - change; // Subtract
                        });
                    }
                });
            }

            // Apply the calculated changes
            for (const type in stockChanges) {
                for (const id in stockChanges[type]) {
                    const change = stockChanges[type][id];
                    if (change !== 0) {
                        const itemCache = type === 'ingredient' ? ingredientsCache : suppliesCache;
                        const item = itemCache.find(i => i.id === id);
                        if (item) {
                            const collRef = getCollectionRef(type + 's');
                            if(collRef) {
                                const docRef = doc(collRef, id);
                                batch.update(docRef, { stock: item.stock + change });
                            }
                        }
                    }
                }
            }
            
            await batch.commit();
        }

        window.updateMultiportionProfit = (input, cost, price) => {
            const qty = parseInt(input.value, 10) || 0;
            const totalProfit = (price - cost) * qty;
            const display = input.nextElementSibling;
            display.textContent = `Profit: $${totalProfit.toFixed(2)}`;
        };
        
        // --- Dynamic Form Element Functions ---
        
        window.addRecipeItem = (type, selectedId = '', quantity = 1) => {
            const container = document.getElementById('recipe-items-container');
            const div = document.createElement('div');
            div.className = 'recipe-item-row flex items-center gap-2';
            div.dataset.type = type;
            
            const cache = type === 'ingredient' ? ingredientsCache : suppliesCache;
            const options = cache.map(item => `<option value="${item.id}" ${item.id === selectedId ? 'selected' : ''}>${item.name} ${item.providerId ? `(${providersCache.find(p=>p.id === item.providerId)?.name || ''})` : ''}</option>`).join('');

            div.innerHTML = `
                <select class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="">Select ${type}...</option>
                    ${options}
                </select>
                <input type="number" value="${quantity}" min="0" step="any" class="w-24 rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Qty">
                <span class="text-sm text-gray-500">${type === 'ingredient' ? (cache.find(i=>i.id===selectedId)?.unit || '') : 'unit(s)'}</span>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
            `;
            container.appendChild(div);
        };

        window.addOrderItem = (selectedId = '', quantity = 1) => {
            const container = document.getElementById('order-items-container');
            const div = document.createElement('div');
            div.className = 'order-item-row flex items-center gap-2';
            
            const options = recipesCache.map(rec => `<option value="${rec.id}" ${rec.id === selectedId ? 'selected' : ''}>${rec.name}</option>`).join('');

            div.innerHTML = `
                <select class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="">Select recipe...</option>
                    ${options}
                </select>
                <input type="number" value="${quantity}" min="1" class="w-24 rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Qty">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
            `;
            container.appendChild(div);
        }

        window.populateProviderDropdowns = function() {
            const select = document.getElementById('ingredient-provider');
            select.innerHTML = `<option value="">Select a provider...</option>` + providersCache.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        window.populateCustomerDropdowns = function() {
            const select = document.getElementById('order-customer');
            select.innerHTML = `<option value="">Select a customer...</option>` + customersCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // --- UI Control (Tabs, Modals) ---
        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(`${tabId}-tab`).classList.add('active');
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
        };

        window.openModal = (modalId) => {
            // Reset forms before opening
            if (modalId !== 'delete-confirm-modal') {
                const form = document.getElementById(`${modalId.replace('-modal', '')}-form`);
                if(form) form.reset();
                // Clear dynamic content
                if(modalId === 'add-recipe-modal') document.getElementById('recipe-items-container').innerHTML = '';
                if(modalId === 'add-order-modal') document.getElementById('order-items-container').innerHTML = '';
                // Clear hidden IDs
                const hiddenIdFields = form.querySelectorAll('input[type="hidden"]');
                hiddenIdFields.forEach(field => field.value = '');
            }
            document.getElementById(modalId).style.display = 'flex';
        };

        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        // Close modal on backdrop click
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal-backdrop')) {
                closeModal(event.target.id);
            }
        });

    </script>
</body>
</html>
